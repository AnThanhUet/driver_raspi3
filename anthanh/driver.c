#include <linux/init.h>
#include <linux/module.h>
#include <linux/kernel.h>
#include <linux/delay.h>
#include <linux/gpio.h>
#include <linux/slab.h>
#include <linux/uaccess.h>
#include <asm/uaccess.h>
#include <linux/cdev.h>
#include <linux/device.h>
#include <linux/fd.h>
#include <stdlib.h>
#include "lcd.h"

unsigned char font6[][6] ={ 
   {0x00,0x00,0x00,0x00,0x00,0x00} // 20   
  ,{0x00,0x7E,0x10,0x08,0x70,0x00} // 21 !  
  ,{0x00,0x10,0x7C,0x38,0x10,0x00} // 22 "
  ,{0x00,0x14,0x7f,0x14,0x7f,0x14} // 23 #
  ,{0x00,0x24,0x2a,0x7f,0x2a,0x12} // 24 $
  ,{0x00,0x23,0x13,0x08,0x64,0x62} // 25 %
  ,{0x00,0x36,0x49,0x55,0x22,0x50} // 26 &
  ,{0x00,0x00,0x06,0x06,0x00,0x00} // 27 '           //0x03 0x05 neu muon la dau phay
  ,{0x00,0x00,0x1c,0x22,0x41,0x00} // 28 (
  ,{0x00,0x00,0x41,0x22,0x1c,0x00} // 29 )
  ,{0x00,0x00,0x0C,0x12,0x12,0x0C} // 2a *
  ,{0x00,0x08,0x08,0x3e,0x08,0x08} // 2b +
  ,{0x00,0x00,0x50,0x30,0x00,0x00} // 2c ,
  ,{0x00,0x08,0x08,0x08,0x08,0x08} // 2d -
  ,{0x00,0x00,0x60,0x60,0x00,0x00} // 2e .
  ,{0x00,0x20,0x10,0x08,0x04,0x02} // 2f /
  ,{0x00,0x3C,0x42,0x42,0x42,0x3C} // 30 0
  ,{0x00,0x44,0x44,0x7E,0x40,0x40} // 31 1          0xFF,0xFF,0xFF,0xFF,0xFF,0xFF
  ,{0x00,0x64,0x52,0x52,0x52,0x4C} // 32 2
  ,{0x00,0x24,0x42,0x4A,0x4A,0x34} // 33 3
  ,{0x00,0x30,0x28,0x24,0x7E,0x20} // 34 4
  ,{0x00,0x2E,0x4A,0x4A,0x4A,0x32} // 35 5
  ,{0x00,0x3C,0x4A,0x4A,0x4A,0x30} // 36 6
  ,{0x00,0x02,0x02,0x72,0x0A,0x06} // 37 7
  ,{0x00,0x34,0x4A,0x4A,0x4A,0x34} // 38 8
  ,{0x00,0x0C,0x52,0x52,0x52,0x3C} // 39 9
  ,{0x00,0x00,0x66,0x66,0x00,0x00} // 3a :
  ,{0x00,0x80,0xE6,0x66,0x00,0x00} // 3b ;
  ,{0x00,0x08,0x14,0x22,0x00,0x00} // 3c <
  ,{0x00,0x28,0x28,0x28,0x28,0x00} // 3d =
  ,{0x00,0x00,0x22,0x14,0x08,0x00} // 3e >
  ,{0x00,0x04,0x52,0x12,0x0C,0x00} // 3f ?
  ,{0x00,0x34,0x4A,0x7A,0x42,0x3C} // 40 @
  ,{0x00,0x7C,0x12,0x12,0x12,0x7C} // 41 A
  ,{0x00,0x7E,0x4A,0x4A,0x4A,0x34} // 42 B
  ,{0x00,0x3C,0x42,0x42,0x42,0x24} // 43 C
  ,{0x00,0x7E,0x42,0x42,0x42,0x3C} // 44 D
  ,{0x00,0x7E,0x4A,0x4A,0x42,0x42} // 45 E
  ,{0x00,0x7E,0x0A,0x0A,0x0A,0x02} // 46 F
  ,{0x00,0x3C,0x42,0x52,0x52,0x74} // 47 G
  ,{0x00,0x7E,0x08,0x08,0x08,0x7E} // 48 H
  ,{0x00,0x42,0x42,0x7E,0x42,0x42} // 49 I
  ,{0x00,0x22,0x42,0x3E,0x02,0x02} // 4a J
  ,{0x00,0x7E,0x08,0x18,0x24,0x42} // 4b K
  ,{0x00,0x7E,0x40,0x40,0x40,0x40} // 4c L
  ,{0x00,0x7E,0x04,0x08,0x04,0x7E} // 4d M
  ,{0x00,0x7E,0x04,0x08,0x10,0x7E} // 4e N
  ,{0x00,0x3C,0x42,0x42,0x42,0x3C} // 4f O
  ,{0x00,0x7E,0x12,0x12,0x12,0x0C} // 50 P
  ,{0x00,0x3C,0x42,0x42,0x22,0x5C} // 51 Q
  ,{0x00,0x7E,0x0A,0x1A,0x2A,0x44} // 52 R
  ,{0x00,0x24,0x4A,0x4A,0x4A,0x32} // 53 S
  ,{0x00,0x02,0x02,0x7E,0x02,0x02} // 54 T
  ,{0x00,0x3E,0x40,0x40,0x40,0x3E} // 55 U
  ,{0x00,0x1E,0x20,0x40,0x20,0x1E} // 56 V
  ,{0x00,0x7E,0x20,0x10,0x20,0x7E} // 57 W
  ,{0x00,0x42,0x24,0x18,0x24,0x42} // 58 X
  ,{0x00,0x06,0x08,0x70,0x08,0x06} // 59 Y
  ,{0x00,0x62,0x52,0x4A,0x46,0x42} // 5a Z
  ,{0x00,0x00,0x7f,0x41,0x41,0x00} // 5b [
  ,{0x00,0x02,0x04,0x08,0x10,0x20} // 5c Â¥
  ,{0x00,0x00,0x41,0x41,0x7f,0x00} // 5d ]
  ,{0x00,0x04,0x02,0x01,0x02,0x04} // 5e ^
  ,{0x00,0x40,0x40,0x40,0x40,0x40} // 5f _
  ,{0x00,0x00,0x01,0x02,0x04,0x00} // 60 `    
  ,{0x00,0x20,0x54,0x54,0x54,0x78} // 61 a
  ,{0x00,0x7E,0x50,0x48,0x48,0x30} // 62 b
  ,{0x00,0x30,0x48,0x48,0x48,0x48} // 63 c
  ,{0x00,0x30,0x48,0x48,0x48,0x7E} // 64 d
  ,{0x00,0x38,0x54,0x54,0x54,0x58} // 65 e
  ,{0x00,0x08,0x7C,0x0A,0x02,0x04} // 66 f
  ,{0x00,0x0c,0x52,0x52,0x52,0x3e} // 67 g
  ,{0x00,0x7E,0x10,0x08,0x08,0x70} // 68 h
  ,{0x00,0x00,0x48,0x7A,0x40,0x00} // 69 i
  ,{0x00,0x20,0x48,0x48,0x3A,0x00} // 6a j
  ,{0x00,0x7E,0x10,0x28,0x48,0x00} // 6b k
  ,{0x00,0x00,0x42,0x7E,0x40,0x00} // 6c l
  ,{0x00,0x78,0x08,0x70,0x08,0x70} // 6d m
  ,{0x00,0x78,0x08,0x08,0x08,0x70} // 6e n
  ,{0x00,0x30,0x48,0x48,0x48,0x30} // 6f o
  ,{0x00,0x7C,0x12,0x12,0x12,0x0C} // 70 p
  ,{0x00,0x0C,0x12,0x12,0x12,0x7C} // 71 q
  ,{0x00,0x78,0x10,0x08,0x08,0x10} // 72 r
  ,{0x00,0x48,0x54,0x54,0x54,0x24} // 73 s
  ,{0x00,0x08,0x3E,0x48,0x40,0x20} // 74 t
  ,{0x00,0x38,0x40,0x40,0x20,0x78} // 75 u
  ,{0x00,0x18,0x20,0x40,0x20,0x18} // 76 v
  ,{0x00,0x38,0x40,0x20,0x40,0x38} // 77 w
  ,{0x00,0x44,0x28,0x10,0x28,0x44} // 78 x
  ,{0x00,0x4C,0x50,0x50,0x50,0x3C} // 79 y
  ,{0x00,0x44,0x64,0x54,0x4C,0x44} // 7a z 
};
unsigned char LCD[6][84] ={ 

{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
};

#define CE  23 // set chan raspi
#define RST 26
#define DC  22                          
#define SDA_LCD 27 // DIN
#define CLK_LCD 17             


#define swap(a, b) {int t = a; a = b; b = t; }    // chuong trinh con ( hoan doi gia tri a va b) 
#define setpx(x) (1 << (x))


void LCD_gui1byte(unsigned char x, unsigned char byte)  // ham gui 1 byte du lieu den LCD
{
  unsigned char i;
  bit outbit;
  DC=x;		// x =1 hien thi ra man hinh, x=0 la gui lenh dieu khien LCD
  for(i=0;i<8;i++)
  {
    outbit=byte&0x80;	  // lay ra bit thu 7
	gpio_set_value(SDA_LCD, outbit);			  // gan chan SDA cho gia tri cua bit thu 7
	gpio_set_value(CLK_LCD, 1);				  // tao xung nhip day bit qua LCD
	gpio_set_value(CLK_LCD, 0);
	byte = byte << 1;	  // dich trai 1 lan de chuan bi lay bit tiep theo
  }
}

void LCD_khoitao()
{
    gpio_set_value(CLK_LCD, 0);
    gpio_set_value(CE, 0);		// cho phep LCD hoat dong
    udelay(2);
    gpio_set_value(RST, 0);
    udelay(2);
    gpio_set_value(RST, 1); // reset LCD
  udelay(2);
  LCD_gui1byte(0,0x21); // che do dieu khien LCD, gia tri nap vao 0x21 : tuong duong ghi du lieu theo chieu ngang va cho phep thuc hien cac lenh bo sung
  LCD_gui1byte(0,0xC0); // che do dieu khien LCD, dung dien ap 5V
  LCD_gui1byte(0,0x20); // che do dieu khien LCD, dung cac lenh co ban
  LCD_gui1byte(0,0x0C); //che do dieu khien LCD, che do hien thi thong thuong ||   hoac 0x0D neu muon nen den chu trang || 0x0C la hien binh thuong 
}

void LCD_guikitu(unsigned char kitu)
{
  unsigned char x,i;
  x=kitu-32;
  for(i=0;i<6;i++)
  {
    LCD_gui1byte(1,font6[x][i]);
  }
}

void LCD_guichuoi(unsigned char *chuoi)
{
 	while(*chuoi)
	{
	  LCD_guikitu(*chuoi);
	  chuoi++;
	}
}

void LCD_chonvitri(unsigned char x, unsigned char y)
{
   LCD_gui1byte(0,(0x40 | (y-1)));  // chon dong
   LCD_gui1byte(0,(0x80 | (x-1)));  // chon cot
}

void LCD_xoamanhinh()
{
 char x,y;
 for(x=0;x<6;x++)
 {
   for(y=0;y<84;y++)
   {
     LCD[x][y]=0;
   }
 }
}

void LCD_xuat()
{
  unsigned char x,y;
  for(y=0;y<6;y++)
	  {
	   for(x=0;x<84;x++)
		  {
		    LCD_gui1byte(1,LCD[y][x]);
		  }
  }
}

void LCD_sang1px(unsigned char x, unsigned char y)
{  
   LCD[y/8][x-1]|=setpx(y%8); 
}

void LCD_veduongngang(unsigned char x, unsigned char y,unsigned char dodai)
{
char dem;
  if(dodai>84)
  {
    dodai=84;
  }
  for(dem=0;dem<dodai;dem++)
  {
    LCD_sang1px(x+dem,y);
  }
} 

void LCD_veduongdoc(unsigned char x, unsigned char y,unsigned char dodai)
{
char dem;
  if(dodai>48)
  {
    dodai=48;
  }
  for(dem=0;dem<dodai;dem++)
  {
    LCD_sang1px(x,y+dem);
  }
}


void LCD_vehinhchunhat(unsigned char x, unsigned char y,unsigned char cao, unsigned char rong)
{
   unsigned char x1,y1;
   x1=x+rong-1;
   y1=y+cao-1;
   LCD_veduongdoc(x,y,cao); LCD_veduongdoc(x1,y,cao);     
   LCD_veduongngang(x,y,rong); LCD_veduongngang(x,y1,rong);  
}
void LCD_veduongthang(int x, int y,int x1, int y1)
{
 int dx,dy,err,ystep; 
 int steep=abs(y1-y) > abs(x1-x);   
 int xtd,ytd;
 if(x==x1)
 {
  ytd=y1-y;  
  ytd=abs(ytd);
  if(y1>y)
  { 
    LCD_veduongdoc(x,y,ytd+1);    
  }
  else
  {
    LCD_veduongdoc(x1,y1,ytd+1);
  }
  return;
 } 
 
  if(y==y1)
 {    
  xtd=x1-x;
  xtd=abs(xtd);
  if(x1>x)
  { 
    LCD_veduongngang(x,y,xtd+1);    
  }
  else
  {
    LCD_veduongngang(x1,y1,xtd+1);
  }
  return;
 }
 if (steep) 
  {
    swap(x, y);
    swap(x1, y1);
  }    
  
  if (x > x1) {
    swap(x, x1);
    swap(y, y1);
  }
 dx=x1-x;
 dy=abs(y1-y);
 err=dx/2;  
  
  if (y < y1)
   {
    ystep = 1;
   }      
  
   else {
    ystep = -1;} 
    
  for (; x<=x1; x++) 
  {
    if (steep) 
    {
      LCD_sang1px(y,x);

    } 
    
    else   
    
    {
      LCD_sang1px(x, y);
    }   
    
    err -= dy;     
    
    if (err < 0) {
      y += ystep;
      err += dx;
    }
  }
 
}

#define BCM2837_PERI_BASE   0x3F000000
#define GPIO_BASE           0x3F200000 /* GPIO controller */

#define PAGE_SIZE   (4*1024)
#define BLOCK_SIZE  (4*1024)


#define LCD_WIDTH   84
#define LCD_HEIGHT  48

#define LCD_C   0
#define LCD_D   1


static dev_t dev_num = 0;
static struct class *lcd_class;
static struct cdev lcd_cdev;

static int __init my_lcd_init(void);
static void __exit my_lcd_exit(void);

/* ---------- D R I V E R   S P E C I F I C ------------------*/

static int lcd5110_open(struct inode *inode, struct file *filp);
static int lcd5110_release(struct inode *inode, struct file *filp);
static ssize_t lcd5110_read(struct file *filp, char __user *buf, size_t count, loff_t *f_pos);
static ssize_t lcd5110_write(struct file *filp, const char *buf, size_t count, loff_t *f_pos);

/* -----------------------------------------------------------*/
static struct file_operations lcd5110_fops = 
{
    .owner  =   THIS_MODULE,
    .open   =   lcd5110_open, 
    .read   =   lcd5110_read,
    .write  =   lcd5110_write,
    .release =  lcd5110_release, 
};

static int __init my_lcd_init(void)
{
    if ((alloc_chrdev_region(&dev_num, 0, 1, "lcd5110")) < 0)
    {
        pr_err("Cannot allocate major number\n");
        goto r_unreg;
    }
    /* create cdev structure */
    cdev_init(&lcd_cdev, &lcd5110_fops);
    /* add character device to the system */
    if ((cdev_add(&lcd_cdev, dev_num, 1)) < 0)
    {
        pr_err("Cannot add the device to the system\n");
        goto r_del;
    }
    /* Create struct class */
    if ((lcd_class = class_create(THIS_MODULE, "lcd5110_class")) == NULL)
    {
        pr_err("Cannot create the struct class\n");
        goto r_class;
    }
    /* Create device */
    if ((device_create(lcd_class, NULL, dev_num, NULL, "lcd5110_device")) == NULL)
    {
        pr_err("Cannot create the device\n");
        goto r_device;
    }

    gpio_direction_output(CE, 0);
    gpio_direction_output(RST, 0);
    gpio_direction_output(DC, 0);
    gpio_direction_output(SDA_LCD, 0);
    gpio_direction_output(CLK_LCD, 0);
    
    LCD_khoitao();      

    LCD_chonvitri(10,2);
    LCD_guichuoi("Goc DIY.com");  
    LCD_chonvitri(1,3);     
    LCD_guichuoi("Chia se dam me");       
    LCD_chonvitri(20,4);     
    LCD_guichuoi("dien tu");      
    LCD_chonvitri(20,5);     
    LCD_guichuoi("tin hoc");

    printk(KERN_INFO "Module lcd5110 inserted\n");
    return 0;

    r_device:
        device_destroy(lcd_class, dev_num);
    r_class:
        class_destroy(lcd_class);
    r_del:
        cdev_del(&lcd_cdev);
    r_unreg:
        unregister_chrdev_region(dev_num, 1);
    
    return -1;
}

static void __exit my_lcd_exit(void)
{
    int pins[5] = {RES, SCE, DC, SDIN, SCLK};
        for(int g=0; g<6; g++)
        {
            gpio_free(pins[g]);
        }
    device_destroy(lcd_class, dev_num);
    class_destroy(lcd_class);
    cdev_del(&lcd_cdev);
    unregister_chrdev_region(dev_num, 1);
    printk(KERN_INFO "Module lcd5110 rmmoved\n");
    kfree(kbuf);
}

static int lcd5110_open(struct inode *inode, struct file *filp)
{
    printk(KERN_INFO "Opened\n");
    return 0;
}

static int lcd5110_release(struct inode *inode, struct file *filp)
{
    printk(KERN_INFO "Closed\n");
    return 0;
}

static ssize_t lcd5110_read(struct file *filp, char __user *buf, size_t count, loff_t *f_pos)
{
    return 0;
}

static ssize_t lcd5110_write(struct file *filp, const char *buf, size_t count, loff_t *f_pos)
{
    /* Buffer writing to the device */
    char *kbuf = kcalloc((count + 1), sizeof(char), GFP_KERNEL);

    if (copy_to_user(kbuf, buf, count) != 0)
    {
        kfree(kbuf);
        return -EFAULT;
    }
    kbuf[count-1] = 0;

    clearLcdScreen();
    writeStringToLcd(kbuf);
    //kfree(kbuf);
    return count;
}


module_init(my_lcd_init);
module_exit(my_lcd_exit);
MODULE_LICENSE("GPL");
MODULE_AUTHOR("HuynhLD+AnNT");
MODULE_DESCRIPTION("Nokia Driver");
